<div class="committee-home-container" *ngIf="committee">
  <!-- Committee Navbar (Top Div) -->
  <div class="committee-navbar bg-white border-bottom sticky-top">
    <div class="container-fluid px-4 py-3">
      <div class="d-flex justify-content-between align-items-center">
        <!-- Left side - Back button and committee name -->
        <div class="d-flex align-items-center">
          <button class="btn btn-outline-secondary me-3" (click)="goBack()">
            <i class="fas fa-arrow-left me-2"></i>Back
          </button>
          <h4 class="mb-0 fw-bold text-primary">{{ committee.name }}</h4>
        </div>

        <!-- Right side - Committee head controls -->
        <div class="d-flex gap-2" *ngIf="isCommitteeHead">
          <button class="btn btn-outline-primary btn-sm" (click)="createPost()">
            <i class="fas fa-plus me-1"></i>Post
          </button>
          <button class="btn btn-outline-warning btn-sm" (click)="changeHead()">
            <i class="fas fa-exchange-alt me-1"></i>Change Head
          </button>
          <button class="btn btn-outline-info btn-sm" (click)="openNotifications()">
            <i class="fas fa-bell me-1"></i>Notifications
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Committee Profile (Middle Div) -->
  <div class="committee-profile bg-light py-4">
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-md-8">
          <div class="card">
            <div class="card-body text-center">
              <!-- Profile Image -->
              <div class="committee-image-container mb-3">
                <div class="committee-avatar mx-auto">
                  <img 
                    *ngIf="committeeProfileImage" 
                    [src]="committeeProfileImage" 
                    alt="Committee Profile"
                    class="committee-profile-img"
                  >
                  <div *ngIf="!committeeProfileImage" class="default-avatar">
                    <i class="fas fa-users fa-4x text-muted"></i>
                  </div>
                </div>
                
                <!-- Image upload for committee head -->
                <div *ngIf="isCommitteeHead" class="mt-2">
                  <input 
                    type="file" 
                    #fileInput 
                    (change)="onFileSelected($event)"
                    accept="image/*"
                    class="d-none"
                  >
                  <button 
                    class="btn btn-sm btn-outline-primary"
                    (click)="fileInput.click()"
                    [disabled]="uploadingImage"
                  >
                    <i class="fas fa-camera me-1"></i>
                    {{ committeeProfileImage ? 'Change Image' : 'Upload Image' }}
                  </button>
                  <button 
                    *ngIf="selectedFile"
                    class="btn btn-sm btn-primary ms-2"
                    (click)="uploadProfileImage()"
                    [disabled]="uploadingImage"
                  >
                    <i class="fas fa-upload me-1"></i>
                    {{ uploadingImage ? 'Uploading...' : 'Save' }}
                  </button>
                </div>
              </div>

              <!-- Committee Info -->
              <h3 class="fw-bold mb-2">{{ committee.name }}</h3>
              <p class="text-muted mb-3">{{ committee.description }}</p>
              <div class="committee-meta">
                <span class="badge bg-primary me-2">
                  <i class="fas fa-user me-1"></i>Head: {{ committee.head_name }}
                </span>
                <span class="badge bg-secondary">
                  <i class="fas fa-users me-1"></i>
                  {{ committeeMembers.length }} Members
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Content Sections (Bottom Div) -->
  <div class="committee-content">
    <div class="container py-4">
      <!-- Section Navigation -->
      <div class="section-nav mb-4">
        <div class="btn-group w-100" role="group">
          <button 
            class="btn"
            [class.btn-primary]="activeSection === 'posts'"
            [class.btn-outline-primary]="activeSection !== 'posts'"
            (click)="setActiveSection('posts')"
          >
            <i class="fas fa-images me-2"></i>Posts
          </button>
          <button 
            class="btn"
            [class.btn-primary]="activeSection === 'groupChat'"
            [class.btn-outline-primary]="activeSection !== 'groupChat'"
            (click)="setActiveSection('groupChat')"
            *ngIf="isCommitteeMember"
          >
            <i class="fas fa-comments me-2"></i>Group Chat
          </button>
          <button 
            class="btn"
            [class.btn-primary]="activeSection === 'headChat'"
            [class.btn-outline-primary]="activeSection !== 'headChat'"
            (click)="setActiveSection('headChat')"
            *ngIf="isCommitteeHead"
          >
            <i class="fas fa-user-tie me-2"></i>Head Chat
          </button>
        </div>
      </div>

      <!-- Posts Section -->
      <div *ngIf="activeSection === 'posts'" class="posts-section">
        <app-committee-post-grid 
          [committee]="committee"
          [isCommitteeHead]="isCommitteeHead">
        </app-committee-post-grid>
      </div>

      <!-- Group Chat Section -->
      <div *ngIf="activeSection === 'groupChat'" class="group-chat-section">
        <app-committee-group-chat 
          [committee]="committee"
          [isCommitteeMember]="isCommitteeMember">
        </app-committee-group-chat>
      </div>

      <!-- Head Chat Section -->
      <div *ngIf="activeSection === 'headChat'" class="head-chat-section">
        <app-committee-head-chatbox 
          [committee]="committee"
          [isCommitteeHead]="isCommitteeHead">
        </app-committee-head-chatbox>
      </div>
    </div>
  </div>
</div>

<!-- Loading state -->
<div *ngIf="!committee" class="text-center py-5">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Loading committee...</span>
  </div>
</div>

<!-- Change Head Modal: simple accessible modal with typeahead search -->
<div *ngIf="showChangeHeadModal" class="modal-backdrop d-flex align-items-center justify-content-center" style="background: rgba(0,0,0,0.5); position: fixed; inset: 0; z-index: 1050;">
  <div class="card shadow" role="dialog" aria-modal="true" aria-labelledby="changeHeadTitle" style="max-width: 520px; width: 92%;">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 id="changeHeadTitle" class="mb-0">Change Committee Head</h5>
      <button type="button" class="btn btn-sm btn-outline-secondary" (click)="cancelChangeHead()" aria-label="Close">Close</button>
    </div>
    <div class="card-body">
      <p class="text-muted mb-3">Type the name of a member in this committee. Select from the dropdown to set them as the new head.</p>

      <div class="mb-3 position-relative">
        <label class="form-label" for="memberSearch">Member name</label>
        <input
          id="memberSearch"
          type="text"
          class="form-control"
          placeholder="Start typing a name..."
          [(ngModel)]="memberSearchTerm"
          (ngModelChange)="onMemberSearch($event)"
          autocomplete="off"
        />

        <!-- Suggestions dropdown -->
        <div *ngIf="memberSuggestions.length > 0" class="list-group mt-1" style="position: absolute; width: 100%; z-index: 1060;">
          <button
            type="button"
            class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
            *ngFor="let m of memberSuggestions"
            (click)="selectCandidate(m)"
          >
            <span>{{ m.name }}</span>
            <span class="badge bg-secondary text-uppercase">{{ m.role }}</span>
          </button>
        </div>

        <div *ngIf="searchingMembers" class="form-text mt-1">Searching...</div>
      </div>

      <div class="alert alert-info" *ngIf="selectedNewHead">
        Selected new head: <strong>{{ selectedNewHead.name }}</strong>
      </div>
    </div>
    <div class="card-footer d-flex justify-content-end gap-2">
      <button class="btn btn-outline-secondary" (click)="cancelChangeHead()" [disabled]="savingHead">Cancel</button>
      <button class="btn btn-warning" (click)="confirmChangeHead()" [disabled]="!selectedNewHead || savingHead">
        {{ savingHead ? 'Saving...' : 'Confirm Change' }}
      </button>
    </div>
  </div>
</div>
